{"componentChunkName":"component---src-templates-post-jsx","path":"/NotionAPI를-활용한-자동-포스팅11/","result":{"data":{"site":{"siteMetadata":{"title":"SharkniA"}},"markdownRemark":{"id":"8aeec2a3-8c02-5cf6-81c2-d98f08e09fd3","excerpt":"요약 짬짬이 틈을 내서 하는 작업이다 보니 문서화 작업을 제대로 못했습니다. 짜잘짜잘한 오류 수정이 있었으며, 비교적 큰 수정도 있었고 완성이 됐다고 판단해 버전을 정의하고 릴리즈도 해봤습니다.  버그 수정 코드 블록의 들여쓰기가 제대로 적용되지 않는 문제가 수정되었습니다.    스타일 내에서 언더바가 제대로 인식되지 않는 문제가 수정되었습니다.  타이틀…","html":"<h2>요약</h2>\n<p>짬짬이 틈을 내서 하는 작업이다 보니 문서화 작업을 제대로 못했습니다. 짜잘짜잘한 오류 수정이 있었으며, 비교적 큰 수정도 있었고 완성이 됐다고 판단해 버전을 정의하고 릴리즈도 해봤습니다. </p>\n<h2>버그 수정</h2>\n<ul>\n<li>코드 블록의 들여쓰기가 제대로 적용되지 않는 문제가 수정되었습니다. </li>\n<li><code class=\"language-text\">코드</code>  스타일 내에서 언더바가 제대로 인식되지 않는 문제가 수정되었습니다. </li>\n<li>타이틀에 스타일이 포함된 경우(노션에서 확인하기 어려움) 타이틀이 짤리던 문제가 수정되었습니다. </li>\n<li>기타 일부 스타일이 적용되지 않던 문제가 해결됐습니다. </li>\n<li>API 호출 시 타임아웃이 될 경우 대책없이 프로그램이 중단되던 문제가 해결됐습니다. </li>\n</ul>\n<h2>업데이트</h2>\n<ul>\n<li>이제 토글 블록이 지원됩니다.</li>\n<li>블로그 자동 배포가 워크플로우에 포함되었습니다. 이를 위해 깃허브 계정을 미리 설정할 수 있게 되었습니다. </li>\n<li>메타데이터 초기화 기능이 추가되었습니다. 이제 새로운 계정으로 세팅 시 메타데이터 파일이 초기화됩니다.</li>\n<li>코드 리팩토링의 일부로 일부 코드의 디렉토리가 분리되었습니다. </li>\n<li><code class=\"language-text\">v1.0.0-beta</code>가 릴리즈 되었습니다. Readme가 완성되었습니다. </li>\n<li>프로젝트 이름이 <code class=\"language-text\">nolog</code>로 확정되었습니다.</li>\n<li>라이센스가 명시되었습니다. </li>\n</ul>\n<h2>타임아웃 문제의 해결</h2>\n<p>기타 다른 버그는 짜잘짜잘한 수정이었지만 타임아웃 문제 해결은 나름대로 머리를 써서 구현했으므로 해당 과정을 별도로 기록합니다. </p>\n<h3>문제 파악</h3>\n<p>노션 API를 사용하고 있고, 해당 API를 사용하기 위해서 notionClient 라이브러리를 사용하고 있습니다. 그리고 주로 데이터베이스 정보를 읽어올 때, 페이지 안의 내용을 읽어올 때, 블록 안의 내용을 읽어올 때 해당 라이브러리를 사용하여 통신합니다. </p>\n<p>하지만 가끔 가다 간헐적으로 규칙성 없이 timeout이 발생하는 문제가 있었습니다. 이를 해결하기 위해 Notion Client 라이브러리를 상속한 NotionClientWithRetry 클래스를 생성하고, 세가지 메소드에 대해 재시도 로직을 하는 공통 메소드를 생성하고 코드상에서 Client 직접 호출 대신 해당 메소드를 이용해 Client를 호출하도록 수정해주었습니다. </p>\n<details>\n<summary>NotionClientWithRetry.ts</summary>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Client <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@notionhq/client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NotionClientWithRetry</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> maxRetries<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> retryDelay<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        auth<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n        maxRetries<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n        retryDelay<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> auth<span class=\"token operator\">:</span> options<span class=\"token punctuation\">.</span>auth <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>maxRetries <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>maxRetries <span class=\"token operator\">||</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>retryDelay <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>retryDelay <span class=\"token operator\">||</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 기본 1초 대기</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">async</span> <span class=\"token generic-function\"><span class=\"token function\">retryAPI</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n        <span class=\"token function-variable function\">operation</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n        retries<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>maxRetries<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">operation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>retries <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n                <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">[retryAPI] </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>maxRetries <span class=\"token operator\">-</span> retries<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> retrying.....</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n                <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>retryDelay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">retryAPI</span><span class=\"token punctuation\">(</span>operation<span class=\"token punctuation\">,</span> retries <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token function\">blocksRetrieve</span><span class=\"token punctuation\">(</span>args<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> block_id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">retryAPI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>blocks<span class=\"token punctuation\">.</span><span class=\"token function\">retrieve</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token function\">databasesQuery</span><span class=\"token punctuation\">(</span>args<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        database_id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n        filter<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">;</span>\n        sorts<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">retryAPI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>databases<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token function\">pagesRetrieve</span><span class=\"token punctuation\">(</span>args<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> page_id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">retryAPI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pages<span class=\"token punctuation\">.</span><span class=\"token function\">retrieve</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</details>\n<p>따로 사용자가 설정할 수 있지만 기본적으로는 1초에 한 번씩 최대 3번까지 재시도를 하도록 해주었습니다. </p>\n<p>해당 코드를 적용한 이후로는 API 호출에 실패해서 프로그램이 중단되는 일은 겪지 못했습니다. </p>\n<h2>블로그 자동 배포가 포함된 워크플로우 작성</h2>\n<p>블로그 자동 배포 워크플로우는 사실 <a href=\"http://github.io/\">github.io</a> 쪽 레포에 이미 구현이 되어 있어 추가 구현이 필요 없었으며, 깃허브 블로그 테마마다 배포 방식이 다를 수 있어 사실 꼭 구현이 필수인 영역은 아니었습니다. </p>\n<p>하지만 깃허브 액션에 대해 이해도가 깊어질 수 있고, 또 프로젝트의 목적 상 가능하면 하나로 합쳐지는 예시를 제공하는 것도 좋아보여 공부 겸 진행했습니다. </p>","frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(11)","date":"February 04, 2024","update":"February 08, 2024","tags":["Notion-API","Blogging","Hobby","Typescript"],"series":"GitHub Pages와 Notion API 연동"},"fields":{"slug":"/NotionAPI를-활용한-자동-포스팅11/","readingTime":{"minutes":5.47}}},"seriesList":{"edges":[{"node":{"id":"cf782302-a534-55e4-9607-9ba22069ba6d","fields":{"slug":"/Notion-API1/"},"frontmatter":{"title":"Notion API(1)"}}},{"node":{"id":"3a290e6d-b6bb-5ad3-b93c-646dd6597d8b","fields":{"slug":"/githubio를-이용한-블로그/"},"frontmatter":{"title":"github.io를 이용한 블로그"}}},{"node":{"id":"96b463ae-d648-5426-a574-faa73a2daf4d","fields":{"slug":"/githubio-자동배포/"},"frontmatter":{"title":"github.io 자동배포"}}},{"node":{"id":"a38352f2-1a18-57cb-988e-c685e392175d","fields":{"slug":"/Notion-API2/"},"frontmatter":{"title":"Notion API(2)"}}},{"node":{"id":"66bbbd52-9b37-5eea-9c37-1de08fc608f7","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅"}}},{"node":{"id":"ea79504b-7f4b-5185-a504-018bbe1ca05d","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅2/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(2)"}}},{"node":{"id":"613f37b4-2fd9-5208-9d9d-16174c9d3180","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅3/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(3)"}}},{"node":{"id":"81e99043-692d-5112-8edc-5d43774968a0","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅4/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(4)"}}},{"node":{"id":"e35e71eb-8137-5b3d-a497-988e2554e292","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅5/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(5)"}}},{"node":{"id":"ee22bc46-0f12-56ec-9e8a-8cd3b3fe4451","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅6/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(6)"}}},{"node":{"id":"814f77a8-f23a-5f6b-9562-cbab62343d0f","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅7/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(7)"}}},{"node":{"id":"b61dee75-4a5f-5a2d-a782-a5dfc8b65fb6","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅8/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(8)"}}},{"node":{"id":"ff71aedb-1637-5d59-812e-38da46dbaf77","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅9/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(9)"}}},{"node":{"id":"11e3ce39-5b5d-5164-8a1d-f034614e34d4","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅10/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(10)"}}},{"node":{"id":"8aeec2a3-8c02-5cf6-81c2-d98f08e09fd3","fields":{"slug":"/NotionAPI를-활용한-자동-포스팅11/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(11)"}}},{"node":{"id":"f9e23df5-9e1f-5d92-b4b7-0f37d54560f2","fields":{"slug":"/Readme/"},"frontmatter":{"title":"Readme"}}}]},"previous":{"fields":{"slug":"/Github-Actions-Workflow-수동으로-실행하기/"},"frontmatter":{"title":"Github Actions Workflow 수동으로 실행하기"}},"next":{"fields":{"slug":"/Github-Actions-Job---needs/"},"frontmatter":{"title":"Github Actions Job - needs"}}},"pageContext":{"id":"8aeec2a3-8c02-5cf6-81c2-d98f08e09fd3","series":"GitHub Pages와 Notion API 연동","previousPostId":"72e50b04-cb8a-55a6-b4ac-636d3dce4b78","nextPostId":"b81485d3-7cab-52c0-adf9-f489724dc88f"}},"staticQueryHashes":[],"slicesMap":{}}