{"componentChunkName":"component---src-templates-post-jsx","path":"/prepared-statement-does-not-exist-오류/","result":{"data":{"site":{"siteMetadata":{"title":"SharkniA"}},"markdownRemark":{"id":"b1be2bcf-85db-5aa6-96b9-fadfa8cb5016","excerpt":"서론 Supabase에서 제공하는 PostgreSQL 풀러(PgBouncer)를 Transaction 모드로 운영하는 환경에서, Python 3.12과 SQLAlchemy 2.x의 비동기(asyncio) 엔진을 함께 사용할 때  오류가 발생하는 경우가 있습니다. 이 글에서는 오류의 원인과 해결 방법을 코드 예제와 함께 정리합니다. 개발 환경 Python …","html":"<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/b80ac1921a762a523eb725252799a7ea/64756/image1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 66.47058823529413%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpElEQVR42mNgMIxFRoxGcUzG8RAEZKPJoiN0vkEMg3Y4g1YYCOlEwE2EI9yaDWKYjeNEPEsUwptkQxv4nXIZ9KNBeoAmaoYwaIYx6Mfg1MxoGBcwaU/lkTdVQHT0bdmBl/pZUxk0QthNEkwKZpsWzGIxTQQ5DYtm/Wh2q9TQGYfil5xLXH4hYdm5hKXnLErmMehG2tcuV43r1E2fqJcxGWgWo3E8qmYjkGYOq7TwWUeAOuMWn4lZcLJg1yOr0gVaSb32VUsZNUJsq5dIBVQzaEcgfI6i2TotcPKeyDlH45ecBVobOv2AZlKvYc600OkHXVvWqca0A0MRJcyQnQ20OWTagaxNtzM33Excft6vf6f/hJ2+vduUolrkQupZgdoMsAYYUEIvmtMmPXLe8bCZh4Im7/Xp3WaYPY3HOt2zc7Ooa6GIWyHQaKAFOEIbGE8mCUCbi3Y/yd16z3/iLn7nfGAgayX3sZomslmkoFuLHs/60UwG0RL+VfJhjYqRLU6NqzWTekCpBWghpk7sKQyoWiMEqkc7nBGUwohMnrDkDQlV/MkbAMul0Izw2uq6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image1' title='' src='/static/b80ac1921a762a523eb725252799a7ea/ca1dc/image1.png' srcset='/static/b80ac1921a762a523eb725252799a7ea/e7570/image1.png 170w,\n/static/b80ac1921a762a523eb725252799a7ea/f46e7/image1.png 340w,\n/static/b80ac1921a762a523eb725252799a7ea/ca1dc/image1.png 680w,\n/static/b80ac1921a762a523eb725252799a7ea/02d09/image1.png 1020w,\n/static/b80ac1921a762a523eb725252799a7ea/64756/image1.png 1200w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h2>서론</h2>\n<p>Supabase에서 제공하는 PostgreSQL 풀러(PgBouncer)를 Transaction 모드로 운영하는 환경에서,</p>\n<p>Python 3.12과 SQLAlchemy 2.x의 비동기(asyncio) 엔진을 함께 사용할 때 <code class=\"language-text\">prepared statement does not exist</code> 오류가 발생하는 경우가 있습니다.</p>\n<p>이 글에서는 오류의 원인과 해결 방법을 코드 예제와 함께 정리합니다.</p>\n<h2>개발 환경</h2>\n<ul>\n<li>Python 버전: 3.12 이상</li>\n<li>SQLAlchemy 버전: 2.x (비동기 엔진 사용)</li>\n<li>\n<p>데이터베이스: Supabase PostgreSQL + PgBouncer</p>\n<ul>\n<li><code class=\"language-text\">pool_mode = transaction</code></li>\n</ul>\n</li>\n<li>비동기 드라이버: asyncpg</li>\n</ul>\n<h2>문제 정의</h2>\n<p>SQLAlchemy <code class=\"language-text\">AsyncSession</code>으로 반복 쿼리를 실행하다가<code class=\"language-text\">asyncpg.exceptions._base.InterfaceError: prepared statement \"&lt;name>\" does not exist</code> 예외 발생</p>\n<h2>오류 원인 분석</h2>\n<ol>\n<li>\n<p>asyncpg의 Prepared Statement 캐시</p>\n<ul>\n<li>asyncpg는 동일 쿼리를 반복 실행할 때 성능을 높이기 위해 내부적으로 prepared statement를 캐시에 저장합니다. </li>\n</ul>\n</li>\n<li>\n<p>PgBouncer Transaction 모드</p>\n<ul>\n<li><code class=\"language-text\">pool_mode = transaction</code> 설정 시, 각 트랜잭션이 끝날 때마다 서버(PostgreSQL) 쪽의 모든 prepared statement를 삭제합니다.</li>\n<li>커넥션은 유지되지만, 트랜잭션 경계마다 statement 정보가 사라짐</li>\n</ul>\n</li>\n<li>\n<p>충돌 과정</p>\n<ol>\n<li>asyncpg: “지난번에 준비해 둔 statement가 있으니 이름만 주세요”</li>\n<li>PgBouncer: “이미 다 지웠습니다”</li>\n<li>asyncpg: “…그럼 없다고요?” → <code class=\"language-text\">InterfaceError: prepared statement \"&lt;name>\" does not exist</code></li>\n</ol>\n</li>\n</ol>\n<hr style=\"border: none; height: 1px; background-color: #e0e0e0; margin: 16px 0;\" />\n## 문제 재현 예시\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> sqlalchemy<span class=\"token punctuation\">.</span>ext<span class=\"token punctuation\">.</span>asyncio <span class=\"token keyword\">import</span> AsyncSession<span class=\"token punctuation\">,</span> async_sessionmaker<span class=\"token punctuation\">,</span> create_async_engine\n<span class=\"token keyword\">from</span> sqlalchemy<span class=\"token punctuation\">.</span>orm <span class=\"token keyword\">import</span> declarative_base\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>config <span class=\"token keyword\">import</span> settings\n\n<span class=\"token comment\"># DATABASE_URL 예시: \"postgresql://user:pass@host:5432/dbname\"</span>\nASYNC_DATABASE_URL <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>DATABASE_URL<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"postgresql://\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"postgresql+asyncpg://\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 비동기 엔진 생성 (statement_cache_size 미설정 상태)</span>\nasync_engine <span class=\"token operator\">=</span> create_async_engine<span class=\"token punctuation\">(</span>\n    ASYNC_DATABASE_URL<span class=\"token punctuation\">,</span>\n    echo<span class=\"token operator\">=</span>settings<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\nAsyncSessionLocal <span class=\"token operator\">=</span> async_sessionmaker<span class=\"token punctuation\">(</span>\n    bind<span class=\"token operator\">=</span>async_engine<span class=\"token punctuation\">,</span>\n    class_<span class=\"token operator\">=</span>AsyncSession<span class=\"token punctuation\">,</span>\n    expire_on_commit<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\nBase <span class=\"token operator\">=</span> declarative_base<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">get_items</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">:</span> AsyncSession<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> session<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>select<span class=\"token punctuation\">(</span>Item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">.</span>scalars<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">async</span> <span class=\"token keyword\">with</span> AsyncSessionLocal<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> session<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            items <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> get_items<span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>200회 반복 실행 시, 약 100회 차 전후로 다음과 같은 오류가 발생합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"plaintext\"><pre class=\"language-plaintext\"><code class=\"language-plaintext\">asyncpg.exceptions._base.InterfaceError: prepared statement \"s_1_select_item\" does not exist</code></pre></div>\n<h2><strong>해결 방법</strong></h2>\n<h3>1. statement_cache_size 비활성화</h3>\n<p>가장 간단한 해결책은 asyncpg의 prepared statement 캐시를 사용하지 않도록 설정하는 것입니다.</p>\n<p>create_async_engine 호출 시 다음과 같이 connect_args에 \"statement_cache_size\": 0을 추가합니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">async_engine <span class=\"token operator\">=</span> create_async_engine<span class=\"token punctuation\">(</span>\n    ASYNC_DATABASE_URL<span class=\"token punctuation\">,</span>\n    echo<span class=\"token operator\">=</span>settings<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">,</span>\n    connect_args<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"statement_cache_size\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 캐시 크기를 0으로 설정</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    pool_pre_ping<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n    pool_recycle<span class=\"token operator\">=</span><span class=\"token number\">3600</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>이렇게 하면 asyncpg가 매번 prepare 없이 쿼리를 바로 전송하기 때문에, PgBouncer가 prepared statement를 삭제하더라도 오류가 발생하지 않습니다.</p>\n<h3>2. Session Pooler 사용</h3>\n<p>statement_cache_size를 비활성화 하더라도 PgBouncer의 Poolmode를 transaction으로 사용하면 이 설정만으로는 오류가 발생합니다. UUID로 매번 statement를 자동생성하라는 권고도 나오곤 하는데, 이렇게 해도 발생하는 경우가 있었습니다. </p>\n<p>편한 방법으로 Session pooler를 사용하겠습니다.</p>\n<p>Session 모드는 클라이언트가 연결을 유지하는 동안 다른 클라이언트가 해당 연결을 사용할 수 없으므로, Transaction 모드에 비해 연결 재사용 효율이 떨어질 수 있습니다. 특히 짧은 시간 동안만 연결했다 끊는 작업(예: 서버리스 함수)이 매우 빈번하다면, Transaction 모드보다 더 많은 실제 연결이 필요하게 되어 리소스 사용량이 늘거나 연결 제한에 더 빨리 도달할 수 있지만, 현재는 FastAPI만 사용하고 있으므로 걱정이 없습니다. </p>\n<h3>3. 직접 연결 (PgBouncer 미사용)</h3>\n<p>PgBouncer Transaction 모드를 완전히 배제하고, 애플리케이션에서 직접 PostgreSQL 서버에 연결하는 방법입니다.</p>\n<p>이 경우 SQLAlchemy <code class=\"language-text\">create_async_engine</code>에 일반 <code class=\"language-text\">postgresql+asyncpg://</code> URL을 그대로 사용합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">ASYNC_DATABASE_URL <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>DATABASE_URL  <span class=\"token comment\"># \"postgresql+asyncpg://...\" 그대로 사용</span>\n\nasync_engine <span class=\"token operator\">=</span> create_async_engine<span class=\"token punctuation\">(</span>\n    ASYNC_DATABASE_URL<span class=\"token punctuation\">,</span>\n    echo<span class=\"token operator\">=</span>settings<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">,</span>\n    pool_size<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span>           <span class=\"token comment\"># 적절히 커넥션 풀 크기 조정</span>\n    max_overflow<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\"># 최대 오버플로우 수</span>\n    pool_pre_ping<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\"># 커넥션 유효성 검사</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h4>Supabase에서는..?</h4>\n<p>현재 Supabase에서 다음과 같이 권고하고 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">    Not IPv4 compatible\n\nUse Session Pooler if on a IPv4 network or purchase IPv4 add-on</code></pre></div>\n<p>Supabase의 기본 데이터베이스 연결 주소가 주로 IPv6 네트워크를 사용하며, 주인님의 서버처럼 IPv4 네트워크 환경에서 직접 접속하려면 문제가 발생할 수 있다는 것을 의미합니다. Supabase는 Session Pooler 사용을 권장하고 있으며 굳이 IPv4를 사용하려면 추가 애드온 구매를 요구합니다. </p>\n<h3>장단점 평가</h3>\n<table>\n<thead>\n<tr>\n<th>구분</th>\n<th>장점</th>\n<th>단점</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>성능</td>\n<td>- Prepared statement 캐시 활용으로 쿼리 준비 시간 절감<br/>- PgBouncer 오버헤드 제거</td>\n<td>- 다수의 커넥션이 직접 서버에 연결되어 자원 소모 증가</td>\n</tr>\n<tr>\n<td>안정성</td>\n<td>- Prepared statement 캐싱과 호환<br/>- 트랜잭션 경계 관리 일관성 보장</td>\n<td>- 커넥션 수 초과 시 장애 위험<br/>- 개별 애플리케이션에서 풀링 관리 필요</td>\n</tr>\n<tr>\n<td>운영 복잡도</td>\n<td>- 설정이 단순 (PgBouncer 설정 불필요)</td>\n<td>- 장애 발생 시 개별 커넥션 재시도 로직 추가 필요</td>\n</tr>\n<tr>\n<td>확장성</td>\n<td>- 쿼리 성능 최적화 여지 (캐시, 파라미터 바인딩)</td>\n<td>- 대규모 트래픽 시 DB 서버 부하 증가</td>\n</tr>\n</tbody>\n</table>","frontmatter":{"title":"prepared statement does not exist  오류","date":"April 27, 2025","update":"July 02, 2025","tags":["Supabase","SqlAlchemy","FastAPI","Python","Postgresql"],"series":"취미생활 - FastAPI 서버 구성"},"fields":{"slug":"/prepared-statement-does-not-exist-오류/","readingTime":{"minutes":6.49}}},"seriesList":{"edges":[{"node":{"id":"de24f32b-02cd-55dc-8a4f-2d6d3b167304","fields":{"slug":"/오라클-서버-https-인증서-설치하기/"},"frontmatter":{"title":"오라클 서버 https 인증서 설치하기"}}},{"node":{"id":"b1be2bcf-85db-5aa6-96b9-fadfa8cb5016","fields":{"slug":"/prepared-statement-does-not-exist-오류/"},"frontmatter":{"title":"prepared statement does not exist  오류"}}},{"node":{"id":"fc1ca32a-2bbd-5396-afb8-a2b1405ba9c3","fields":{"slug":"/Ubuntu-서버에서-메모리-사용량-확인-및-스왑-설정으로-안정성-높이기/"},"frontmatter":{"title":"\nUbuntu 서버에서 메모리 사용량 확인 및 스왑 설정으로 안정성 높이기"}}}]},"previous":{"fields":{"slug":"/오라클-서버-https-인증서-설치하기/"},"frontmatter":{"title":"오라클 서버 https 인증서 설치하기"}},"next":{"fields":{"slug":"/Ubuntu-서버에서-메모리-사용량-확인-및-스왑-설정으로-안정성-높이기/"},"frontmatter":{"title":"\nUbuntu 서버에서 메모리 사용량 확인 및 스왑 설정으로 안정성 높이기"}}},"pageContext":{"id":"b1be2bcf-85db-5aa6-96b9-fadfa8cb5016","series":"취미생활 - FastAPI 서버 구성","previousPostId":"de24f32b-02cd-55dc-8a4f-2d6d3b167304","nextPostId":"fc1ca32a-2bbd-5396-afb8-a2b1405ba9c3"}},"staticQueryHashes":[],"slicesMap":{}}