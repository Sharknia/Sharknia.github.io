{"componentChunkName":"component---src-templates-post-jsx","path":"/PostgreSQL-Advisory-Locks-트랜잭션-레벨에서-구현/","result":{"data":{"site":{"siteMetadata":{"title":"SharkniA"}},"markdownRemark":{"id":"8e27233b-d081-512d-9e66-3fe55b19003e","excerpt":"서론 동시성 제어 문제를 해결하기 위한 여러가지 방법을 고민 끝에 PostgreSQL Advisory Locks를 사용한 방법으로 구현하기로 했다.  구현을 하면서 겪은 과정을 여기에 기록한다.  구현 목표 현재 회사에서는 FastAPI와 SqlAlchemy 2.0, PostgreSQL을 사용하고 있다. 아주 짧은 텀으로 중복으로 온 API 요청에 대해 …","html":"<h2>서론</h2>\n<p><a href=\"https://sharknia.github.io/2024-01-30/%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%A0%9C%EC%96%B4%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0\">동시성 제어 문제를 해결하기 위한 여러가지 방법을 고민</a> 끝에 PostgreSQL Advisory Locks를 사용한 방법으로 구현하기로 했다. </p>\n<p>구현을 하면서 겪은 과정을 여기에 기록한다. </p>\n<h2>구현 목표</h2>\n<p>현재 회사에서는 FastAPI와 SqlAlchemy 2.0, PostgreSQL을 사용하고 있다. 아주 짧은 텀으로 중복으로 온 API 요청에 대해 중복 구매가 되지 않도록 동시성 제어를 하려고 한다. </p>\n<p>유저의 아이디 값 또는 API 고유의 값 + 유저의 아이디 값을 사용해 트랜잭션 레벨에서 PostgreSQL Advisory Locks를 생성하고, 동일한 유저가 PostgreSQL Advisory Locks에 걸린 경우에는 중복 요청이라고 판단하고 두번째 요청은 중단 하거나, 또는 반드시 유효성 검사를 하도록 해 중복 구매가 되는 일이 없게 사전에 차단하려고 한다. </p>\n<h2>구현 사전단계</h2>\n<p><a href=\"https://www.postgresql.org/docs/9.1/functions-admin.html\">공식문서</a>를 살펴보니 트랜잭션 레벨에서의 락을 위해 내가 사용할 수 있는 함수는 두 가지가 있었다. 트랜잭션 레벨의 락은 공통적으로 명시적인 언락이 불가능하다. </p>\n<p>아래의 두가지 함수는 모두 트랜잭션 레벨의 함수로 Advisory Lock을 획득할 수 있다는 점은 같지만, Advisory Lock을 바로 획득하지 못했을 때의 반응이 다르다. </p>\n<h3>pg<em>advisory</em>xact_lock</h3>\n<p>지정된 키에 대한 Advisory Lock을 획득할 때까지 호출을 블로킹(대기)한다. 만약 다른 세션이 이미 해당 키에 대한 Advisory Lock을 갖고 있다면 그 Advisory Lock이 해제될 때까지 현재 세션에서의 처리가 중단된다. </p>\n<p>Advisory Lock을 반드시 획득해야 해서 대기해야 할 경우에 적합하다.</p>\n<h3>pg<em>try</em>advisory<em>xact</em>lock</h3>\n<p>이 함수는 즉시 Advisory Lock을 시도하고 성공하면 True, 실패하면 False를 반환한다. 이 함수는 잠금 획득을 위해 대기하지 않으며, 잠금이 이미 다른 세션에 의해 보유되고 있는 경우 즉시 실패한다.</p>\n<p>Advisory Lock을 반드시 획득할 필요가 없고 대기하지 않고 다른 작업을 수행해야 할 경우에 적합하다. </p>\n<h3>결정</h3>\n<p>우리의 경우에는 쿠폰 중복 발급을 막으려고 하는 것이므로 만약 이미 잠금이 걸린 경우에는 굳이 나머지 DB 작업을 실행할 필요가 없다. 따라서 pg<em>try</em>advisory<em>xact</em>lock를 사용하는 것이 적절해보인다. </p>\n<h2>구현</h2>\n<p>따라서, 서비스 로직의 시작 지점에 다음의 코드를 넣어 락을 얻거나, 락을 얻지 못한 경우 해당 요청은 실행을 중단하려고 한다. </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Advisory Lock 획득</span>\n    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"SELECT pg_try_advisory_xact_lock(</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>lock<span class=\"token punctuation\">}</span></span><span class=\"token string\">)\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Advisory Lock을 획득하지 못한 경우에는 이미 선제 작업이 있는 것이므로 DB 작업을 계속할 필요가 없으므로</span>\n    <span class=\"token comment\"># 바로 중단한다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> result<span class=\"token punctuation\">.</span>scalar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"Unable to acquire lock\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>SQL 인젝션과 같은 보안 문제를 줄이고 쿼리 구성과 관련된 오류를 예방하기 위해 다음과 같이 코드를 수정했다. </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Advisory Lock 획득</span>\n    result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>execute<span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">.</span>pg_try_advisory_xact_lock<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Advisory Lock을 획득하지 못한 경우에는 이미 선제 작업이 있는 것이므로 DB 작업을 계속할 필요가 없으므로</span>\n    <span class=\"token comment\"># 바로 중단한다.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> result<span class=\"token punctuation\">.</span>scalar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">\"Unable to acquire lock\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>잠금 해제 지점은 어떻게 될까?</h2>\n<p>막연히 트랜잭션이 커밋되거나 롤백될 때라고 알아둬도 충분할 것 같다(세션 주입 방식을 통해 에러가 발생하거나 요청이 정상정이 끝나지 않는 경우에 세션을 롤백하며, 정상적으로 요청이 정리된 경우에는 세션을 커밋하는 과정이 포함되어 있을 것이므로 충분할 것이다).</p>\n<p>다만, 트랜잭션 레벨에서의 락은 명시적으로 언락이 불가능하므로 정확한 언락 지점을 알아둬야 할 필요성이 있다고 느꼈다. </p>\n<ul>\n<li>\n<p>트랜잭션 커밋 또는 롤백</p>\n<p>함수 내부에서 명시적으로 await db.commit() 또는 await db.rollback()이 호출되는 경우에 같은 세션이라고 하더라도 언락된다. </p>\n</li>\n<li>\n<p>비동기 세션 컨텍스트 종료</p>\n<p>AsyncSession 인스턴스가 컨텍스트 매니저(async with) 내에서 사용되고, 해당 컨텍스트 블록이 종료되는 경우</p>\n</li>\n<li>\n<p>예외 발생</p>\n<p>함수 실행 중 예외가 발생하여 처리 흐름이 중단되는 경우. SQLAlchemy의 세션 관리는 트랜잭션이 커밋되지 않으면 자동으로 롤백을 수행하므로 사실상 트랜잭션이 롤백되는 시점과 일치한다. </p>\n</li>\n</ul>","frontmatter":{"title":"PostgreSQL Advisory Locks 트랜잭션 레벨에서 구현","date":"January 30, 2024","update":"January 31, 2024","tags":["Postgresql","SqlAlchemy","Python","DataBase","Work"],"series":null},"fields":{"slug":"/PostgreSQL-Advisory-Locks-트랜잭션-레벨에서-구현/","readingTime":{"minutes":6.19}}},"seriesList":{"edges":[{"node":{"id":"4d7b1074-b3ac-5c36-a73e-a6ed1a202a07","fields":{"slug":"/화상상담을-위한-Janus-구성/"},"frontmatter":{"title":"화상상담을 위한 Janus 구성"}}},{"node":{"id":"be7886e5-3159-5c98-a6f3-04c7a2cb00f1","fields":{"slug":"/JavaScript의-특징-브라우저-동작-원리/"},"frontmatter":{"title":"JavaScript의 특징, 브라우저 동작 원리"}}},{"node":{"id":"9a2c7ec4-7e91-5e89-ba8c-370cbcc12df1","fields":{"slug":"/JavaScript-기본-문법/"},"frontmatter":{"title":"JavaScript 기본 문법"}}},{"node":{"id":"e54de3fc-18b6-547e-b09b-1f53e9088c5c","fields":{"slug":"/JavaScript의-변수/"},"frontmatter":{"title":"JavaScript의 변수"}}},{"node":{"id":"b91beb4b-9e88-5fcc-8c2a-c17cfe8901e8","fields":{"slug":"/JavaScript의-타입-변환과-단축-평가/"},"frontmatter":{"title":"JavaScript의 타입 변환과 단축 평가"}}},{"node":{"id":"92c32653-4965-51f9-844b-e2240edb82a0","fields":{"slug":"/JavaScript-클로저/"},"frontmatter":{"title":"JavaScript 클로저"}}},{"node":{"id":"ce5dde98-2a05-5571-8fa3-0142001310e8","fields":{"slug":"/NestJS-소개/"},"frontmatter":{"title":"NestJS 소개"}}},{"node":{"id":"0067c3b8-3361-56fa-8334-a282f0483dba","fields":{"slug":"/DB-튜닝-경험/"},"frontmatter":{"title":"DB 튜닝 경험"}}},{"node":{"id":"6ae7a6a0-7b5c-5841-878c-6d7a3e1ca05e","fields":{"slug":"/MORETHAN-LOG-설치/"},"frontmatter":{"title":"MORETHAN-LOG 설치"}}},{"node":{"id":"05f5432c-a8e7-5f94-a5f2-3f53ee688f7e","fields":{"slug":"/RDB관계형-데이터베이스-RDBMS/"},"frontmatter":{"title":"RDB(관계형 데이터베이스) + RDBMS"}}},{"node":{"id":"994cd992-ad07-50c1-a53f-51327e2718ed","fields":{"slug":"/var와-letconst/"},"frontmatter":{"title":"var와 let,const"}}},{"node":{"id":"b3eaf950-be62-583c-901d-64b231ea1a4e","fields":{"slug":"/MORETHAN-LOG-수정/"},"frontmatter":{"title":"MORETHAN-LOG 수정"}}},{"node":{"id":"dbb851fb-ea02-5fee-9765-511909593b42","fields":{"slug":"/NestJS-설치/"},"frontmatter":{"title":"NestJS 설치"}}},{"node":{"id":"71fda05f-affe-57c1-a82f-b7e0cc751098","fields":{"slug":"/NestJS의-디렉토리-구조/"},"frontmatter":{"title":"NestJS의 디렉토리 구조"}}},{"node":{"id":"d6a60bda-2a50-57da-96b2-b93e35f8dcb5","fields":{"slug":"/웹-사이트-프로젝트-vs-웹-응용-프로그램-프로젝트/"},"frontmatter":{"title":"웹 사이트 프로젝트 vs "}}},{"node":{"id":"ce6456e3-d3a3-51a7-b579-9f3c5f527ccc","fields":{"slug":"/Nuget-패키지-dll-추출/"},"frontmatter":{"title":"Nuget 패키지 dll 추출"}}},{"node":{"id":"a87e2b15-536a-5ca0-b900-e74918dec21f","fields":{"slug":"/무료-웹-호스팅-비교/"},"frontmatter":{"title":"무료 웹 호스팅 비교"}}},{"node":{"id":"d98289b5-f9c9-507e-9dcf-a159fa9a3a68","fields":{"slug":"/PRG-패턴-PostRedirectGet/"},"frontmatter":{"title":"PRG 패턴 (Post/Redirect/Get)"}}},{"node":{"id":"3308bd5e-b7b6-5be9-92d9-fe7476c6402d","fields":{"slug":"/Python-venv-Windows/"},"frontmatter":{"title":"Python venv (Windows)"}}},{"node":{"id":"b0b4f379-3003-5d6c-99b9-6d77e851ef0f","fields":{"slug":"/print와-pprint/"},"frontmatter":{"title":"print와 pprint"}}},{"node":{"id":"94dcf7a2-c028-5af8-a636-eeb08ffcabc0","fields":{"slug":"/정규화와-역정규화/"},"frontmatter":{"title":"정규화와 역정규화"}}},{"node":{"id":"5cb3526c-9ea8-5a35-99d9-0c158d432255","fields":{"slug":"/트래픽-튜닝/"},"frontmatter":{"title":"트래픽 튜닝"}}},{"node":{"id":"a137a64e-c66b-5557-b12d-3d767b828c5b","fields":{"slug":"/npx/"},"frontmatter":{"title":"npx"}}},{"node":{"id":"43386ca5-6d01-5b87-8f92-2696879f9b7b","fields":{"slug":"/Branch/"},"frontmatter":{"title":"Branch"}}},{"node":{"id":"88bcc3b2-d382-561b-8659-7978ed002a5f","fields":{"slug":"/DataTable-클래스/"},"frontmatter":{"title":"DataTable 클래스"}}},{"node":{"id":"4207210d-f1de-5875-97ec-0e7af80ad71e","fields":{"slug":"/Typescript-시작하기/"},"frontmatter":{"title":"Typescript 시작하기"}}},{"node":{"id":"48ba652d-3d02-50d5-b950-ae26be40f119","fields":{"slug":"/gitignore/"},"frontmatter":{"title":"gitignore"}}},{"node":{"id":"8d70bf78-f023-56e8-b297-15d68fdcf917","fields":{"slug":"/Factory-Pattern/"},"frontmatter":{"title":"Factory Pattern"}}},{"node":{"id":"44fc92b7-3ec8-559c-8f3c-7b73aba0f890","fields":{"slug":"/네이밍-규칙naming-conventions/"},"frontmatter":{"title":"네이밍 규칙(naming conventions)"}}},{"node":{"id":"cd5da1fd-9f44-5c6f-96b1-a07978bfbc1d","fields":{"slug":"/AWS-API-Gateway/"},"frontmatter":{"title":"AWS API Gateway"}}},{"node":{"id":"5b5a9934-3d6b-5d4f-919e-d6c81cd9883b","fields":{"slug":"/ColdStart/"},"frontmatter":{"title":"ColdStart"}}},{"node":{"id":"4d66fd32-495b-53b7-a5e6-0b4352890ad6","fields":{"slug":"/Serverless/"},"frontmatter":{"title":"Serverless"}}},{"node":{"id":"cf58cd45-e5c1-5cdc-beb9-e020f0c196c2","fields":{"slug":"/Dynamo-DB/"},"frontmatter":{"title":"Dynamo DB"}}},{"node":{"id":"b28d0ff6-a8f2-57fb-8424-2338940e34f1","fields":{"slug":"/NoSQL/"},"frontmatter":{"title":"NoSQL"}}},{"node":{"id":"75004652-bd2c-508c-a7db-04db313b1921","fields":{"slug":"/REST/"},"frontmatter":{"title":"REST"}}},{"node":{"id":"56f7be0e-73aa-5dad-98d8-f9ac6348bf1a","fields":{"slug":"/TypeError-non-default-argument-content-follows-default-argument/"},"frontmatter":{"title":"TypeError: non-default argument 'content' follows default argument"}}},{"node":{"id":"e5695f18-889e-587d-a870-634628d77470","fields":{"slug":"/브랜치-관리-전략/"},"frontmatter":{"title":"브랜치 관리 전략"}}},{"node":{"id":"d30c0163-0c3a-5b50-bf43-415f6c40b205","fields":{"slug":"/Unit-Test단위-테스트/"},"frontmatter":{"title":"Unit Test(단위 테스트)"}}},{"node":{"id":"8ec56025-47e8-50a0-b09d-bcebf7f5f38f","fields":{"slug":"/__post_init__/"},"frontmatter":{"title":"__post_init__"}}},{"node":{"id":"de1d75f6-399b-5a3a-b601-5a03f25b235d","fields":{"slug":"/dataclass/"},"frontmatter":{"title":"dataclass"}}},{"node":{"id":"a35d8a33-bdfd-5002-a95d-5864be533e04","fields":{"slug":"/FastAPI와-DDD/"},"frontmatter":{"title":"FastAPI와 DDD"}}},{"node":{"id":"a66f0e3d-4d3f-54ac-9189-5ae58e2f030d","fields":{"slug":"/vercel-배포-자동화/"},"frontmatter":{"title":"vercel 배포 자동화"}}},{"node":{"id":"f5b436db-918e-5d7a-9a05-6f44804bf7a4","fields":{"slug":"/AWS-ECSElastic-Container-Service/"},"frontmatter":{"title":"AWS ECS(Elastic Container Service)"}}},{"node":{"id":"f3769235-6b0c-590e-a146-9db1a2921b37","fields":{"slug":"/Blue-Green-Deploy-전략/"},"frontmatter":{"title":"Blue Green Deploy 전략"}}},{"node":{"id":"ea674275-fe3d-5860-a6d2-ac5fd6bbbd63","fields":{"slug":"/CloudFront/"},"frontmatter":{"title":"CloudFront"}}},{"node":{"id":"24501bbd-a049-5cde-b25d-91f5d6d81ad0","fields":{"slug":"/Poetry/"},"frontmatter":{"title":"Poetry"}}},{"node":{"id":"9363605d-e029-574d-850d-fe8e3d772c14","fields":{"slug":"/DynamoDB의-동시성-제어Concurrency-Control/"},"frontmatter":{"title":"DynamoDB의 동시성 제어(Concurrency Control)"}}},{"node":{"id":"f6954f71-a760-58ae-8db7-b7d7dbab417b","fields":{"slug":"/FastAPI/"},"frontmatter":{"title":"FastAPI"}}},{"node":{"id":"22d5ecd2-8499-51ec-bcee-10e7c6a65e0c","fields":{"slug":"/Pydantic-모델/"},"frontmatter":{"title":"Pydantic 모델"}}},{"node":{"id":"1430f86d-737b-54d9-ad6e-ed0da064204b","fields":{"slug":"/FastAPI의-데코레이터/"},"frontmatter":{"title":"FastAPI의 데코레이터"}}},{"node":{"id":"09aa2640-b779-5d7e-821e-fdcbc810306e","fields":{"slug":"/생성기generate-패턴/"},"frontmatter":{"title":"생성기(generate) 패턴"}}},{"node":{"id":"19a83676-7ebb-5df2-89ee-aad5db0ac510","fields":{"slug":"/FastAPI와-asyncio/"},"frontmatter":{"title":"FastAPI와 asyncio"}}},{"node":{"id":"a46250f3-70a4-51a8-99dc-7f8a19e25f30","fields":{"slug":"/FastAPI에서-데코레이터와-Dependency/"},"frontmatter":{"title":"FastAPI에서 데코레이터와 Dependency"}}},{"node":{"id":"e73d2f23-e559-5fd0-b823-3a905a7b23bc","fields":{"slug":"/aiohttp/"},"frontmatter":{"title":"aiohttp"}}},{"node":{"id":"e1614069-fb05-50dc-b571-09619b8b3812","fields":{"slug":"/단축어로-SLACK-프로필-변경하기/"},"frontmatter":{"title":"단축어로 SLACK 프로필 변경하기"}}},{"node":{"id":"e54bc742-9cf7-5c9e-bf8c-7c89cdc68f03","fields":{"slug":"/PynamoDB와-boto3-PynamoDB의-커넥션/"},"frontmatter":{"title":"PynamoDB와 boto3, PynamoDB의 커넥션"}}},{"node":{"id":"56d966ae-83d3-5173-96bb-1656a67b886e","fields":{"slug":"/FastAPI에서-Postgresql의-커넥션-관리/"},"frontmatter":{"title":"FastAPI에서 Postgresql의 커넥션 관리"}}},{"node":{"id":"ffa35bb9-59f6-5d00-a171-3df68d55bc94","fields":{"slug":"/Sqlalchemy-비동기-엔진에서의-Postgresql-Pooler/"},"frontmatter":{"title":"Sqlalchemy 비동기 엔진에서의 Postgresql Pooler"}}},{"node":{"id":"ac6be9fb-f651-5a8b-abe8-875e5c9c5e86","fields":{"slug":"/SqlAlchemy의-QueuePool/"},"frontmatter":{"title":"SqlAlchemy의 QueuePool"}}},{"node":{"id":"c58328fc-45ee-535d-bbd0-11c63e6f91d3","fields":{"slug":"/Union-Type/"},"frontmatter":{"title":"Union Type"}}},{"node":{"id":"3d7c4789-600c-5652-baf1-072ee0673b52","fields":{"slug":"/우분투-용량-관리/"},"frontmatter":{"title":"우분투 용량 관리"}}},{"node":{"id":"2f0bdc06-8ac6-5591-952a-2fa5601cb02c","fields":{"slug":"/Sqlalchemy에서의-트랜잭션-격리-수준-구현/"},"frontmatter":{"title":"Sqlalchemy에서의 트랜잭션 격리 수준 구현"}}},{"node":{"id":"1f5f9a99-fd2f-5150-b295-3ce29b5ab2ad","fields":{"slug":"/트랜잭션-격리-수준Transaction-Isolation-Level/"},"frontmatter":{"title":"트랜잭션 격리 수준(Transaction Isolation Level)"}}},{"node":{"id":"8e27233b-d081-512d-9e66-3fe55b19003e","fields":{"slug":"/PostgreSQL-Advisory-Locks-트랜잭션-레벨에서-구현/"},"frontmatter":{"title":"PostgreSQL Advisory Locks 트랜잭션 레벨에서 구현"}}},{"node":{"id":"eec75730-fbf0-5ffb-a69c-7e5d33807c69","fields":{"slug":"/Sqlalchemy의-func/"},"frontmatter":{"title":"Sqlalchemy의 func"}}},{"node":{"id":"5a91da05-b806-550d-9ec8-cc7981485589","fields":{"slug":"/동시성-제어문제-해결/"},"frontmatter":{"title":"동시성 제어문제 해결"}}},{"node":{"id":"ecef9814-4c6f-5617-9bb1-1c5f56e0b5f7","fields":{"slug":"/vscode-quick-Suggestions/"},"frontmatter":{"title":"vscode-quick Suggestions"}}}]},"previous":{"fields":{"slug":"/NotionAPI를-활용한-자동-포스팅7/"},"frontmatter":{"title":"NotionAPI를 활용한 자동 포스팅(7)"}},"next":{"fields":{"slug":"/Sqlalchemy의-func/"},"frontmatter":{"title":"Sqlalchemy의 func"}}},"pageContext":{"id":"8e27233b-d081-512d-9e66-3fe55b19003e","series":null,"previousPostId":"f3d132ef-938d-5692-a8ad-a99bb5e90216","nextPostId":"eec75730-fbf0-5ffb-a69c-7e5d33807c69"}},"staticQueryHashes":[],"slicesMap":{}}