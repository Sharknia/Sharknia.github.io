---
IDX: "NUM-71"
tags:
  - ETC
  - BackEnd
update: "2024-02-02T16:32:00.000Z"
date: "2023-10-30"
상태: "Ready"
title: "Blue Green Deploy 전략"
---
## 소개

Blue-Green 배포 전략은 지속적인 통합 및 지속적인 배포 환경에서 자주 사용되는 소프트웨어 배포 패턴 중 하나이다. 이 전략의 주요 목표는 시스템의 중단 없이 안전하게 애플리케이션을 배포하고 업데이트 하는 것이다. 

## 핵심 아이디어 

### 두 개의 독립적인 환경

Blue와 Green이라는 두 개의 별도의 환경(또는 색상)이 있다. 일반적으로 한 환경(Blue)은 실제 사용자에게 서비스를 제공하는 라이브 환경이며, 다른 환경(Green)은 새 버전의 애플리케이션을 배포하기 위한 준비 환경이다. 

### 스위치 오버

새 버전의 애플리케이션을 Green 환경에 배포한 후, 모든 테스트와 검증 절차를 거쳐 문제가 없다고 판단되면 트래픽을 Blue 환경에서 Green 환경으로 빠르게 전환(또는 스위치 오버) 한다. 이렇게 하면 실제 사용자는 서비스 중단 없이 새 버전의 어플리케이션을 사용할 수 있다. 

### 롤백 용이

만약 Green 환경의 새 버전에 문제가 발생하면, 트래픽을 다시 Blue 환경으로 즉시 전환하여 이전 버전의 애플리케이션을 사용하게 할 수 있다. 이는 문제가 발생했을 때 빠르게 롤백하는데 큰 도움이 된다. 

## 개요

Blue-Green 배포 전략에서는 실제로 “배포” 하는 작업을 여러번 반복하지 않는다. 대신, 두 개의 독립적인 환경을 유지하고 트래픽을 이 두 환경 사이에서 스위칭한다. 이를 구체적으로 설명하면 다음과 같다. 

1. 초기 상태

    Blue 환경이 라이브 상태이고 실제 사용자 트래픽을 처리하고 있다고 가정한다. 

1. 새 버전 배포

    Green 환경에 새로운 버전의 애플리케이션을 배포한다. 이 시점에서 아직 Blue가 여전히 실제 트래픽을 처리하고 있다. Green은 배포 및 테스트 준비 단계에 있다. 

1. 스위칭

    Green 환경에서의 테스트와 검증이 완료되면 트래픽을 Blue에서 Green으로 스위칭한다. 이제 Green이 라이브 상태가 되어 사용자 트래픽을 처리한다. 

1. 다음 배포

    다음 번 배포 시, Blue 환경을 업데이트하고 검증한 후 트래픽을 다시 Blue로 스위칭한다. 

## 장점

### 빠른 롤백

문제가 발생하면 즉시 이전 버전으로 롤백할 수 있다. 

### 중단시간 없음

사용자에게 서비스 중단 없이 애플리케이션을 배포할 수 있다. 

### 통합 테스트

Green 환경에서 새 버전의 애플리케이션을 배포하기 전에 광범위한 테스트와 검증을 수행할 수 있다. 

## 단점

### 자원 중복

두 개의 독립적인 환경을 유지해야 하므로 추가적인 인프라와 자원이 필요하다. 

### 데이터베이스 동기화

데이터베이스 스키마나 데이터에 변동이 있는 경우 Blue와 Green 환경 사이의 동기화 문제가 발생할 수 있다. 

## Blue-Green은 테스트 서버일까? 

배포 과정에서 한 환경이 새 버전의 검증을 위한 임시 테스트 역할을 하게 되는 것은 맞다. 이렇게 설명하면 테스트 서버와 실서버 역할을 그린과 블루가 번갈아가면서 한다고 착각하기 쉽지만 이보다는 둘 다 실서버의 역할을 할 수 있는 독립적인 프로덕션 환경임을 알아야 한다. 몇 가지 중요한 차이점이 있다. 

### 프로덕션 준비

Blue와 Green 둘 다 프로덕션 트래픽을 처리할 준비가 되어있다. 그러나 일반적인 테스트 서버는 프로덕션 수준의 리소스나 성능을 가지고 있지 않을 수 있다. 

### 스케일

Blue와 Green은 실제 사용자의 트래픽을 처리할 수 있을 만큼 큰 규모로 구축되어야 한다. 반면 테썹은 보통 작은 규모로 운영된다. 

### 데이터 

Blue와 Green은 실제 데이터를 다룬다. 

## Blue-Green 배포에서 DB 관리

Blue-Green 배포 전략에서 데이터베이스의 관리는 중요한 고려사항 중 하나이다. 데이터베이스는 상태를 가지고 있으므로 애플리케이션 코드와는 달리 간단히 스위칭하는게 어렵다. 

### 단일 데이터베이스 사용

같은 DB를 사용하는 것은 가능하다. 하지만 이렇게 할 때 고려해야 할 몇가지 중요한 문제가 있다. 

#### 스키마 변경

데이터베이스 스키마에 변경이 필요한 새 버전의 애플리케이션을 배포할 때 문제가 발생할 수 있다. 새 버전에서 필요한 스키마 변경이 이전 버전과 호환되지 않으면 Green 환경에서의 배포 동안 Blue 환경의 애플리케이션에 문제가 발생할 수 있다. 

#### 데이터 무결성

두 환경이 동일한 데이터베이스를 공유할 경우, 새 버전의 애플리케이션에서 예상치 못한 데이터 변경이 발생하면 이전 버전의 실행에도 영향을 줄 수 있다. 따라서, 롤백에도 영향을 줄 수 있다. 



이를 극복하기 위한 여러 전략이 있다. 예를 들면,

#### 스키마 변경 전략

데이터 베이스 스키마 변경을 두 단계로 나누어 수행한다. 먼저 호환성이 있는 스키마 변경을 실시한 후, 새 버전의 애플리케이션을 배포한다. 그 다음 이전 버전과 호환되지 않는 스키마 변경을 실시한다. 

#### 피쳐 토글

데이터베이스에 영향을 주는 새로운 기능이나 변경 사항을 피쳐 토글로 구현하여, 실제로 데이터베이스에 적용되기 전까지는 활성화하지 않을 수 있다. 

#### 결론

만약 이 방법을 선택할 경우, 새로운 버전의 애플리케이션은 데이터베이스 스키마에 대한 변경이 없거나 하위 호환성을 유지해야 한다. 

### 데이터베이스 마이그레이션

- 배포 전에 필요한 데이터베이스 마이그레이션을 신중하게 계획하고 실행한다. 

- 마이그레이션은 트래픽을 Green 환경으로 전환하기 전에 실행되어야 한다. 

- 롤백 시나리오에 대한 계획도 있어야 한다. 

### 데이터 동기화

- 동기화를 위해 DynamoDB Streams와 Lambda를 사용하여 두 테이블 간의 데이터를 동기화 할 수 있다. 

## ALB-ECS 환경에서의 Blue-Green 배포 전략 시나리오

### 1. 초기 환경 설정

- ECS 클러스터에서 두 개의 서비스(Blue와 Green)을 생성한다. 초기에는 Blue만 활성 상태(현재 트래픽을 받고 있는 상태)이다. 

- ALB 설정: ECS 서비스에 트래픽을 라우팅하기 위해 사용된다. 

- Route 53에 도메인 이름을 설정하고 ALB의 DNS 이름을 지정한다. 

### 2. CodePipeline 설정

- Source: 예를 들면 깃허브 또는 CodeCommit의 소스 변경을 감지하여 파이프라인을 트리거한다. 

- Build: CodeBuild를 사용하여 Docker 이미지를 빌드하고 ECR(Elastic Container Registry)에 푸시한다. 

- Deploy: CodeDeploy를 사용하여 ECS에 새로운 이미지를 배포한다. 

### 3. Blue-Green 배포

- 새로운 코드 변경이 파이프라인을 트리거하면 CodeBuild가 새 Docker 이미지를 빌드하고 ECR에 푸시한다. 

- CodeDeploy는 Green ECS 서비스를 대상으로 새 이미지를 사용하여 작업 정의를 업데이트한다. 

- Green 서비스의 태스크가 성공적으로 시작되면 Blue-Green 배포 설정에 따라 CodeDeploy는 자동으로 ALB의 대상 그룹을 업데이트하여 Green 서비스로 트래픽을 전환한다. 

### 4. 검증 및 롤백

- Green 환경에서 서비스의 동작을 검증한다. 

- CodeDeploy는 선택적으로 사용자 지정 후크를 사용하여 배포 후 검증 스크립트를 실행할 수 있다. 

- 문제가 발생한 경우 원래의 Blue 서비스로 빠르게 전환하여 롤백한다. CodeDeploy는 자동 롤백을 지원하여 이전 상태로 되돌릴 수 있다. 

### 5. 다음 배포 준비

- 다음 배포는 Blue가 새 환경이고 Green이 이전 환경이 된다. 이렇게 두 환경을 번갈아 사용하면서 배포를 진행한다. 

## 기타 배포 전략

1. 카나리아 배포

1. 롤링 배포

1. 기능 토글

1. A/B 테스팅

1. 섀도우 배포



