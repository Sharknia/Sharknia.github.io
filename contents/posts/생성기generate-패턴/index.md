---
tags:
  - Python
update: "2024-01-29"
date: "2023-11-03"
상태: "POST"
title: "생성기(generate) 패턴"
---
## 소개

파이썬의 중요한 특징 중 하나로 이터레이터 프로토콜을 사용하여 데이터의 시퀀스를 느긋하게(lazily) 생성하는데 사용된다. 즉, 생성기는 시퀀스의 전체 항목을 메모리에 한 번에 로드하지 않고 반복(iteration) 할 때마다 하나씩 항목을 생성한다. 

이를 통해 메모리 사용을 줄이고 대용량 또는 무한한 시퀀스를 다룰 수 있다. 

## 이터레이터 프로토콜

파이썬에서 반복 가능한 객체(컬렉션)를 순회하기 위한 규약이다. 이 프로토콜은 반복(iteration) 동작을 정의하며 일련의 요소들에 대해 순차적으로 접근할 수 있게 해준다. 파이썬의 모든 반복 가능한 객체는 이 이터레이터 프로토콜을 구현해야 하며 이는 주로 두 가지 매직 매소드(magic method)로 구성된다. 

#### `__iter__()`

이터레이터 객체를 반환해야 하며, 보통 self를 반환하여 객체 자체가 이터레이터인 경우를 처리한다. 이 메소드는 for 루프와 같은 반복 연산이 시작될 때 호출된다. 

### `__next__()`

컬렉션의 다음 요소를 반환해야 한다. 만약 더 이상 요소가 없으면 `StopIteration` 예외를 발생시켜 반복을 종료해야 한다. 

## 생성기 만드는 방법

### 생성기 함수 (Generator function)

일반 함수와 비슷하지만 `return` 대신 `yield` 문을 사용하여 값을 하나씩 반환한다. `yield` 를 사용하면 함수는 해당 상태에서 실행을 일시 정지하고 다음 값이 요청될 때까지 대기 상태가 된다. 

### 생성기 표현식 (Generator expression)

리스트 컴프리헨션과 유사하지만 괄호를 사용하여 정의한다. 이 방식은 단순한 경우에 대한 생성기를 간결하게 작성할 수 있게 해준다. 

## 예제

### 생성기 함수 예제

```python
def countdown(n):
    print("Starting to count from", n)
    while n > 0:
        yield n
        n -= 1
    print("Done!")

# 생성기 객체를 생성
cd = countdown(3)

# 생성기를 사용
for count in cd:
    print(count)
```

이 코드를 실행하면 3, 2, 1이 출력되고 각 숫자 사이에 다른 코드를 실행할 수 있는 기회가 주어진다. 각 yield 문마다 함수의 상태는 일시 중단되고 다음 반복에서 계속된다. 

### 생성기 표현식 예제

```python
squares = (x*x for x in range(10))

# 생성기를 사용
for square in squares:
    print(square)
```

이 코드는 0부터 9까지의 숫자에 대한 제곱을 출력한다. 반복(iteration)할 때마다 다음 제곱값이 생성되고 모든 값이 한 번에 메모리에 저장되지 않는다. 

## yield

yield는 함수가 값을 반환(return)하면서도 그 상태를 기억하고 일시 중지(pause)되는 것을 가능하게 한다. 이는 함수의 실행을 중단시키지만 함수의 로컬 변수와 실행 상태가 유지되어 나중에 이 함수가 다시 호출될 때 이전 상태에서부터 실행을 재개할 수 있다. 

일반적인 return은 함수의 실행을 완전히 종료하고 해당 함수의 모든 상태(로컬 변수, 실행 컨텍스트)를 버리지만 yeild는 함수가 여전히 살아있다는 점에서 return과 다르다. yeild를 통해 반환된 함수(즉 생성기)는 `__next__()` 메소드를 호출함으로써 (또는 `next()` 함수를 사용하여) 다시 실행될 수 있으며, yield문 바로 다음부터 실행이 이어진다. 

## 이터러블(iterable) 객체

### 소개

멤버를 한 번에 하나씩 반환할 수 있는 객체로, 파이썬에선 주로 순회 가능한 모든 객체를 의미한다. 이터러블 객체는 for 루프와 같은 반복문을 사용해 순회할 수 있으며 이는 그 객체가 반복 가능한(iterable) 인터페이스를 구현하고 있기 때문이다. 

이터러블 객체가 되기 위해서는 객체 내에 `__iterm__()` 메소드를 구현해야 한다. 이 메소드는 이터레이터를 반환하고 이터레이터는 `__next__()` 메소드를 구현하여 순차적으로 값을 반환할 수 있어야 한다. `topIteration` 예외는 이터레이터가 더 이상 반환할 값이 없을 때 발생시켜 반복이 끝났음을 알린다.  

### 파이썬의 이터러블 객체

리스트, 튜플, 문자열, 딕셔너리, 집합 등이 있다. 또한 파일(file) 객체도 이러터블하며 파일의 각 줄을 순회할 수 있다. 

### 예제

```python
my_list = [1, 2, 3, 4]  # 리스트는 이터러블 객체입니다.
for item in my_list:
    print(item)  # 1, 2, 3, 4가 순차적으로 출력됩니다.
```

직접 이터러블 객체를 만들고 싶다면 `__iter__()` 메소드를 포함하는 클래스를 정의할 수 있다. 

```python
class Counter:
    def __init__(self, low, high):
        self.current = low
        self.high = high

    def __iter__(self):
        return self  # self.__next__()를 호출할 이터레이터로 자신을 반환합니다.

    def __next__(self):
        if self.current < self.high:
            num = self.current
            self.current += 1
            return num
        else:
            raise StopIteration

# Counter 인스턴스는 이터러블 객체입니다.
counter = Counter(1, 4)
for num in counter:
    print(num)  # 1, 2, 3이 출력됩니다.
```

위는 사용자 정의 이터러블 객체이다. 

위의 `Counter` 클래스는 `__iter__()`와 `__next__()` 메소드를 정의하여 이터러블 인터페이스를 구현한다. `Counter` 인스턴스를 순회할 때마다 `__next__()` 메소드가 호출되어 숫자를 하나씩 반환하고, 더 이상 반환할 숫자가 없을 때 `StopIteration` 예외가 발생한다.



